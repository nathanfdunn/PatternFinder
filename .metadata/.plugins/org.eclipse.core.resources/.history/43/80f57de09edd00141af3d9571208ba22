package ui;

import java.util.HashMap;

import patternDetection.SimpleTokenStream;
//import ui.AppVar.AppNull;
import ui.AppVar.*;

public class CommandApp {

	private IInputReader in;
	private boolean quit;
	private HashMap<String, AppVar<? extends Object>> variables;
	private IAppOutput out;
//	private static final AppVar<? extends Object> 
	
	private static final AppNull NULL = AppNull.NULL;
	
	public void execute(String cmd){
		
		
	}
	
	
	
//	public AppVar<? extends Object> eval(String functionName, String[] args){
//		
//	}
	
	
	
	
	public AppVar<? extends Object> eval(String s){
		int lParenInd = s.indexOf('(');
		int rParenInd = s.lastIndexOf(')');
		
		if (lParenInd == -1 || rParenInd == -1){
			return atomicEval(s);
		}else{
			if (lParenInd != 0 || rParenInd != s.length()-1){
				showError("Bad command: "+s);
				return NULL;
			}
			
			
			//Do stuff for expression evaluation
		}
	}

	
	public void run(){
		while (!quit){
			String cmd = in.getInput();
			execute(cmd);
		}
	}
	
	private String[] parseCommand(String cmd){
		return cmd.split("\\s+");
	}
	
	private AppVar<? extends Object> set(String varName, AppVar<? extends Object> obj ){
		if (CommandAppParser.isValidVarName(varName)){
			variables.put(varName, obj);
			return obj;
		}
		showWarning("Invalid LHS (Bad variable name)");
		return NULL;
	}
	
	
	
	private void quit(){
		quit = true;
	}
	
//	private AppVar<SimpleTokenStream> tokenize()
	
	
	
	
	/**
	 * Evaluates either a literal or a variable
	 * @param s
	 * @return
	 */
	public AppVar<? extends Object> atomicEval(String s){
		AppVar<? extends Object> out = varEval(s);
		if (out != NULL) return out;
		out = stringLitEval(s);
		if (out != NULL) return out;
		out = intLitEval(s);
		if (out != NULL) return out;
		out = doubleLitEval(s);
		if (out != NULL) return out;
		out = boolLitEval(s);
		if (out != NULL) return out;
		
		showError("Unknown atomic expression");
		return NULL;
	}
	
	
	private AppVar<? extends Object> varEval(String s){ 
		if (isVariable(s)) {
			return variables.get(s);
		} else {
//			showWarning("Variable '"+s+"' is undefined");
			return AppNull.NULL;
		}
	}
	
	private AppVar<? extends Object> stringLitEval(String s){ 
		int quoteInd = s.indexOf('"');
		int quoteInd2 = s.lastIndexOf('"');
		if (quoteInd == 0 && quoteInd2 == s.length()-1 && quoteInd!=quoteInd2){
			return new AppString(s.substring(quoteInd+1, quoteInd2));
		}else{
			return NULL;
		}
	}

	private AppVar<? extends Object> boolLitEval(String s){
		if (s.equals("true"))
			return AppBool.TRUE;
		if (s.equals("false"))
			return AppBool.FALSE;
		return NULL;
	}
	
	private AppVar<? extends Object> intLitEval(String s){
		try{
			Integer i = Integer.parseInt(s);
			return new AppInt(i);
		}catch(NumberFormatException e){
			return NULL;
		}
	}
	
	private AppVar<? extends Object> doubleLitEval(String s){
		try{
			Double d = Double.parseDouble(s);
			return new AppDouble(d);
		}catch(NumberFormatException e){
			return NULL;
		}
	}
	
	private boolean isVariable(String name){
		return variables.containsKey(name);
	}
	
	public void showWarning(String warningMessage){
		out.print("Warning: "+warningMessage);
	}
	
	public void showError(String errorMessage){
		out.print("Error: "+errorMessage);
	}
	
}




